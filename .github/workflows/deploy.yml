# Build the app and commit the built site to main in docs/
# Repo Settings → Pages → Source = "Deploy from a branch" → Branch: main, Folder: /docs
# Uses reusable workflow from devops-toolkit
name: Deploy to GitHub Pages

on:
  push:
    branches: ['${{ github.event.repository.default_branch }}']
    paths-ignore:
      - 'docs/**'
  workflow_dispatch:

env:
  DEVOPS_TOOLKIT_REPO: ${{ vars.DEVOPS_TOOLKIT_REPO || 'susanavenda/devops-toolkit' }}
  DEVOPS_TOOLKIT_BRANCH: ${{ vars.DEVOPS_TOOLKIT_BRANCH || 'main' }}

permissions:
  contents: write
  security-events: read

jobs:
  # Security checks before deployment
  security-checks:
    name: Pre-deployment Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Run security scan
        uses: ${{ env.DEVOPS_TOOLKIT_REPO }}/.github/workflows/security-scan.yml@${{ env.DEVOPS_TOOLKIT_BRANCH }}
        with:
          scan-type: 'all'
        secrets:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  verify-assets:
    name: Verify Assets
    runs-on: ubuntu-latest
    needs: security-checks
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Verify public/ has required assets
        run: |
          for f in public/labels.json public/jobs.json public/education.json public/techskills.json public/certifications.json public/recommendations.json; do
            test -f "$f" || (echo "Missing $f (edit files in public/, not root)" && exit 1)
          done
          test -f public/profile.jpg || (echo "Missing public/profile.jpg" && exit 1)
          ls -la public/

  build-and-deploy:
    name: Build and Deploy
    needs: [security-checks, verify-assets]
    uses: ${{ env.DEVOPS_TOOLKIT_REPO }}/.github/workflows/github-pages-deploy.yml@${{ env.DEVOPS_TOOLKIT_BRANCH }}
    with:
      build-command: 'npm run build'
      install-command: 'npm ci'
      source-dir: 'dist'
      target-dir: 'docs'
      node-version: '20'
    secrets:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
