name: Auto-merge Dependabot PRs

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  check_suite:
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  auto-merge:
    name: Auto-merge Dependabot PRs
    runs-on: ubuntu-latest
    if: |
      github.event.pull_request.user.login == 'dependabot[bot]' ||
      (github.event_name == 'check_suite' && github.event.check_suite.pull_requests[0].user.login == 'dependabot[bot]')
    
    steps:
      - name: Get PR number
        id: pr_number
        uses: actions/github-script@v8
        with:
          script: |
            let prNumber;
            if (context.payload.pull_request) {
              prNumber = context.payload.pull_request.number;
            } else if (context.payload.check_suite && context.payload.check_suite.pull_requests.length > 0) {
              prNumber = context.payload.check_suite.pull_requests[0].number;
            }
            core.setOutput('number', prNumber);
            return prNumber;

      - name: Check PR status and merge if ready
        uses: actions/github-script@v8
        with:
          script: |
            const prNumber = ${{ steps.pr_number.outputs.number }};
            
            // Get PR details
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            // Skip if already merged or closed
            if (pr.merged || pr.state !== 'open') {
              console.log(`PR #${prNumber} is already ${pr.merged ? 'merged' : pr.state}`);
              return;
            }
            
            // Check if PR is mergeable
            if (!pr.mergeable || pr.mergeable_state !== 'clean') {
              console.log(`PR #${prNumber} is not ready to merge. State: ${pr.mergeable_state}`);
              return;
            }
            
            // Get check runs for the PR head SHA
            const { data: checks } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.head.sha
            });
            
            // Check if all checks have passed
            const allChecksPassed = checks.check_runs.every(check => 
              check.status === 'completed' && check.conclusion === 'success'
            );
            
            if (!allChecksPassed) {
              const failedChecks = checks.check_runs.filter(check => 
                check.status === 'completed' && check.conclusion !== 'success'
              );
              console.log(`PR #${prNumber} has ${failedChecks.length} failed checks. Waiting...`);
              return;
            }
            
            // Try to enable auto-merge first (preferred method)
            try {
              await github.rest.pulls.enableAutoMerge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: 'squash'
              });
              console.log(`✅ Enabled auto-merge for PR #${prNumber}`);
            } catch (error) {
              // If auto-merge not available, merge directly
              if (error.status === 404 || error.status === 403) {
                console.log(`Auto-merge not available, merging directly...`);
                try {
                  await github.rest.pulls.merge({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: prNumber,
                    merge_method: 'squash'
                  });
                  console.log(`✅ Merged PR #${prNumber}`);
                  
                  // Delete the Dependabot branch
                  if (pr.head.ref.startsWith('dependabot/')) {
                    try {
                      await github.rest.git.deleteRef({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        ref: `heads/${pr.head.ref}`
                      });
                      console.log(`✅ Deleted branch ${pr.head.ref}`);
                    } catch (deleteError) {
                      console.log(`Could not delete branch: ${deleteError.message}`);
                    }
                  }
                } catch (mergeError) {
                  console.log(`Could not merge PR #${prNumber}: ${mergeError.message}`);
                }
              } else {
                console.log(`Auto-merge already enabled or error: ${error.message}`);
              }
            }
